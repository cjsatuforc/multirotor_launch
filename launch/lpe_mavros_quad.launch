<?xml version="1.0" encoding="UTF-8"?>
<launch>

  <arg name="MARKER_NAME" default="pixhawk" />
  <arg name="PX4_DEV" default="/dev/ttyACM0:921600"/>

  <arg name="BASE_STATION_NAME" default="base_station"/>
  <arg name="BASE_STATION_ADDRESS" default="localhost"/>
  <machine name="$(arg BASE_STATION_NAME)" address="$(arg BASE_STATION_ADDRESS)"/>

  <arg name="VIZ_THROTTLE_SPEED" default="16384"/>
  <arg name="VIZ_THROTTLE_SPEED_HALF" value="$(eval arg('VIZ_THROTTLE_SPEED')/2.0)"/>
  <arg name="MOCAP_THROTTLE_SPEED" default="16384"/>

  <group ns="$(arg MARKER_NAME)">
    <!-- Throttle and relay at the same time
      from  /vrpn_client_node/$(arg MARKER_NAME)/pose
      to $(MARKER_NAME)/mavros/mocap/pose
      throttle to  MOCAP_THROTTLE_SPEED bytes/sec
      run on BASE_STATION_NAME
    -->
    <node pkg="topic_tools" type="throttle" name="mocap_throttle"
    args="bytes /vrpn_client_node/$(arg MARKER_NAME)/pose $(arg MOCAP_THROTTLE_SPEED) 1.0 mavros/mocap/pose"
    machine="$(arg BASE_STATION_NAME)">
    </node>

    <!-- Startup the mavros px4 node -->
    <include file="$(find mavros)/launch/px4.launch">
        <arg name="fcu_url" value="$(arg PX4_DEV)"/>
    </include>

    <!-- Send throttled visualization information back
      from mavros/local_positon/pose & mavros/setpoint_position/local 
      to viz_throttle/*
      throttle to  VIZ_THROTTLE_SPEED/2.0 bytes/sec
      run locally
    -->
    <node pkg="topic_tools" type="throttle" name="viz_pose_throttle"
    args="bytes mavros/local_position/pose $(arg VIZ_THROTTLE_SPEED_HALF) 1.0 viz_throttle/local_position/pose">
    </node>
    <node pkg="topic_tools" type="throttle" name="viz_setpoint_throttle"
    args="bytes mavros/setpoint_position/local $(arg VIZ_THROTTLE_SPEED_HALF) 1.0 viz_throttle/setpoint_position/local">
    </node>

    <!-- run the visualization on the base station -->
    <node pkg="mavros_extras" type="copter_visualization" name="copter_visualization"
     output="log" machine="$(arg BASE_STATION_NAME)">

        <remap from="local_position" to="viz_throttle/local_position/pose"/>
        <remap from="local_setpoint" to="viz_throttle/setpoint_position/local"/>
        <param name="fixed_frame_id" value="world"/>
        <param name="child_frame_id" value="$(arg MARKER_NAME)"/>

    </node>

  </group>

</launch>
